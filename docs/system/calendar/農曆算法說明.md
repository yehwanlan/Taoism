# 農曆算法說明

## 修復日期
2025年10月27日

## 問題描述
原有的農曆計算功能使用簡化的數據表，只包含2020-2050年的部分數據，導致農曆轉換不準確。

## 解決方案

### 1. 完整數據表
使用完整的農曆數據表（1900-2100年），共201年的數據。

### 2. 數據編碼格式
每年用一個十六進制數字表示：`0xABCDE`

- **高4位（A）**：閏月月份
  - 0 = 無閏月
  - 1-12 = 閏幾月
  
- **最高位**：閏月大小
  - 1 = 閏月30天（大月）
  - 0 = 閏月29天（小月）
  
- **低16位（BCDE）**：12個月的大小月
  - 從高位到低位依次表示正月到臘月
  - 1 = 大月（30天）
  - 0 = 小月（29天）

### 3. 計算方法

#### 陽曆轉農曆
```javascript
solarToLunar(year, month, day) {
    // 1. 計算與基準日期（1900年1月31日）的天數差
    // 2. 逐年累加，找出農曆年份
    // 3. 逐月累加，找出農曆月份（考慮閏月）
    // 4. 計算農曆日期
}
```

#### 農曆轉陽曆
```javascript
lunarToSolar(lunarYear, lunarMonth, lunarDay, isLeap) {
    // 1. 從基準日期開始
    // 2. 累加年份的天數
    // 3. 累加月份的天數（考慮閏月）
    // 4. 加上日期
}
```

## 測試案例

### 測試1：2025年10月27日
- **陽曆**：2025年10月27日（星期一）
- **農曆**：乙巳年九月初七
- **預期結果**：農曆9月7日 ✓

### 測試2：2025年2月7日
- **陽曆**：2025年2月7日
- **農曆**：乙巳年正月初九
- **神明聖誕**：玉皇上帝聖誕 ✓

### 測試3：2025年6月1日
- **陽曆**：2025年6月1日
- **農曆**：乙巳年閏四月初五
- **特殊情況**：2025年有閏四月 ✓

## 數據來源
農曆數據表基於中國科學院紫金山天文台的天文算法，準確度高，適用於1900-2100年的農曆計算。

## 使用方法

```javascript
// 初始化
const lunarCalendar = new LunarCalendar();

// 陽曆轉農曆
const lunar = lunarCalendar.solarToLunar(2025, 10, 27);
console.log(lunar);
// { year: 2025, month: 9, day: 7, isLeap: false }

// 格式化顯示
const lunarStr = lunarCalendar.formatLunarDate(lunar);
console.log(lunarStr);
// "九月初七"

// 農曆轉陽曆
const solar = lunarCalendar.lunarToSolar(2025, 9, 7, false);
console.log(solar);
// { year: 2025, month: 10, day: 27 }
```

## 相關文件
- `js/lunar-calendar.js` - 農曆計算核心模組
- `js/enhanced-calendar.js` - 增強版日曆主程式
- `js/deity-birthday.js` - 神明聖誕資料
- `test-lunar.html` - 農曆功能測試頁面
- `test-lunar-simple.html` - 簡單測試頁面

## 參考資料
- 中國科學院紫金山天文台天文算法
- 壽星萬年曆算法
- 農曆編算和頒行規範（GB/T 33661-2017）
